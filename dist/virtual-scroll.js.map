{"version":3,"file":"virtual-scroll.js","sourceRoot":"","sources":["../src/virtual-scroll.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,sCAauB;AAEvB,0CAA+C;AAmC/C;IAuCI,gCAAoB,OAAmB,EAAU,QAAkB;QAA/C,YAAO,GAAP,OAAO,CAAY;QAAU,aAAQ,GAAR,QAAQ,CAAU;QApCnE,UAAK,GAAU,EAAE,CAAC;QAelB,WAAM,GAAwB,IAAI,mBAAY,EAAS,CAAC;QAGxD,WAAM,GAA8B,IAAI,mBAAY,EAAe,CAAC;QAGpE,UAAK,GAA8B,IAAI,mBAAY,EAAe,CAAC;QAGnE,QAAG,GAA8B,IAAI,mBAAY,EAAe,CAAC;QAUjE,gBAAW,GAAY,IAAI,CAAC;IAE2C,CAAC;IAExE,yCAAQ,GAAR;QACI,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,aAAa,EAAE,QAAQ,EAAE,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC5G,IAAI,CAAC,cAAc,GAAG,CAAC,CAAC,CAAC,mFAAmF;QAC5G,IAAI,CAAC,eAAe,GAAG,CAAC,CAAC,CAAC,qFAAqF;IACnH,CAAC;IAED,4CAAW,GAAX,UAAY,OAAsB;QAC9B,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;QAC/B,IAAI,CAAC,WAAW,GAAG,SAAS,CAAC;QAC7B,IAAI,CAAC,OAAO,EAAE,CAAC;IACnB,CAAC;IAED,4CAAW,GAAX;QACI,kDAAkD;QAClD,sFAAsF;QACtF,gFAAgF;QAChF,EAAE,CAAC,CAAC,IAAI,CAAC,gBAAgB,KAAK,SAAS,CAAC,CAAC,CAAC;YACtC,4BAA4B;YAC5B,IAAI,CAAC,gBAAgB,EAAE,CAAC;QAC5B,CAAC;IACL,CAAC;IAED,wCAAO,GAAP;QACI,qBAAqB,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IAC1D,CAAC;IAED,2CAAU,GAAV,UAAW,IAAS;QAChB,IAAI,KAAK,GAAW,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACrD,EAAE,CAAC,CAAC,KAAK,GAAG,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC;YAAC,MAAM,CAAC;QAE5D,IAAI,CAAC,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACnC,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,WAAW,CAAC;YACpE,CAAC,CAAC,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC;QACrE,IAAI,CAAC,OAAO,EAAE,CAAC;IACnB,CAAC;IAEO,iDAAgB,GAAxB;QACI,IAAI,SAAS,CAAC;QACd,IAAI,WAAW,CAAC;QAChB,IAAI,QAAQ,GAAG,IAAI,CAAC,iBAAiB,CAAC,aAAa,CAAC,QAAQ,CAAC;QAC7D,GAAG,CAAC,CAAC,WAAW,GAAG,CAAC,EAAE,WAAW,GAAG,QAAQ,CAAC,MAAM,EAAE,WAAW,EAAE,EAAE,CAAC;YACjE,EAAE,CAAC,CAAC,SAAS,IAAI,SAAS,IAAI,SAAS,KAAK,QAAQ,CAAC,WAAW,CAAC,CAAC,SAAS,CAAC;gBAAC,KAAK,CAAC;YACnF,SAAS,GAAG,QAAQ,CAAC,WAAW,CAAC,CAAC,SAAS,CAAC;QAChD,CAAC;QACD,MAAM,CAAC,WAAW,CAAC;IACvB,CAAC;IAEO,oDAAmB,GAA3B;QACI,IAAI,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC;QACpC,IAAI,OAAO,GAAG,IAAI,CAAC,iBAAiB,CAAC,aAAa,CAAC;QAEnD,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;QAC7B,IAAI,SAAS,GAAG,KAAK,CAAC,MAAM,CAAC;QAC7B,IAAI,SAAS,GAAG,EAAE,CAAC,WAAW,GAAG,IAAI,CAAC,cAAc,CAAC;QACrD,IAAI,UAAU,GAAG,EAAE,CAAC,YAAY,GAAG,IAAI,CAAC,eAAe,CAAC;QAExD,IAAI,iBAAiB,CAAC;QACtB,EAAE,CAAC,CAAC,IAAI,CAAC,UAAU,IAAI,SAAS,IAAI,IAAI,CAAC,WAAW,IAAI,SAAS,CAAC,CAAC,CAAC;YAChE,iBAAiB,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,qBAAqB,EAAE,GAAG;gBACpF,KAAK,EAAE,SAAS;gBAChB,MAAM,EAAE,UAAU;aACrB,CAAC;QACN,CAAC;QACD,IAAI,UAAU,GAAG,IAAI,CAAC,UAAU,IAAI,iBAAiB,CAAC,KAAK,CAAC;QAC5D,IAAI,WAAW,GAAG,IAAI,CAAC,WAAW,IAAI,iBAAiB,CAAC,MAAM,CAAC;QAE/D,IAAI,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,gBAAgB,EAAE,CAAC,CAAC;QACvD,IAAI,iBAAiB,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,UAAU,CAAC,CAAC,CAAC;QACxE,IAAI,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,WAAW,CAAC,CAAC,CAAC;QACpE,EAAE,CAAC,CAAC,WAAW,KAAK,CAAC,IAAI,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,SAAS,GAAG,IAAI,CAAC,YAAY,GAAG,SAAS,CAAC,GAAG,iBAAiB,IAAI,SAAS,CAAC,CAAC,CAAC;YACjH,WAAW,GAAG,iBAAiB,CAAC;QACpC,CAAC;QAED,MAAM,CAAC;YACH,SAAS,EAAE,SAAS;YACpB,SAAS,EAAE,SAAS;YACpB,UAAU,EAAE,UAAU;YACtB,UAAU,EAAE,UAAU;YACtB,WAAW,EAAE,WAAW;YACxB,WAAW,EAAE,WAAW;YACxB,WAAW,EAAE,WAAW;YACxB,iBAAiB,EAAE,iBAAiB;SACvC,CAAC;IACN,CAAC;IAEO,+CAAc,GAAtB;QACI,IAAI,EAAE,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC;QAEpC,IAAI,CAAC,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACnC,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;QAC7B,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,SAAS,GAAG,CAAC,CAAC,WAAW,CAAC;QAChE,EAAE,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;YAC3D,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,SAAS,GAAG,IAAI,CAAC,YAAY,CAAC;QAC7D,CAAC;QAED,IAAI,gBAAgB,GAAG,EAAE,CAAC,SAAS,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,SAAS,GAAG,CAAC,CAAC,WAAW,CAAC;QACtF,IAAI,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,EAAE,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,CAAC;QAEnH,IAAI,WAAW,GAAG,GAAG,CAAC;QACtB,IAAM,MAAM,GAAG,GAAG,GAAG,CAAC,CAAC,WAAW,CAAC;QACnC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;YACT,WAAW,GAAG,GAAG,GAAG,CAAC,CAAC,WAAW,GAAG,MAAM,CAAC;QAC/C,CAAC;QACD,IAAI,QAAQ,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,WAAW,GAAG,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,WAAW,GAAG,CAAC,CAAC,WAAW,CAAC,CAAC;QACxF,IAAI,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,CAAC;QAE7E,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,GAAG,CAAC,CAAC,WAAW,CAAC,CAAC;QACnE,EAAE,CAAC,CAAC,KAAK,KAAK,IAAI,CAAC,aAAa,IAAI,GAAG,KAAK,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;YAE3D,yBAAyB;YACzB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC,CAAC;YAE1C,qBAAqB;YACrB,EAAE,CAAC,CAAC,KAAK,KAAK,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,WAAW,KAAK,KAAK,CAAC,CAAC,CAAC;gBAC7D,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,KAAK,OAAA,EAAE,GAAG,KAAA,EAAE,CAAC,CAAC;YACpC,CAAC;YAED,mBAAmB;YACnB,EAAE,CAAC,CAAC,GAAG,KAAK,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,KAAK,KAAK,CAAC,CAAC,CAAC;gBACzD,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,KAAK,OAAA,EAAE,GAAG,KAAA,EAAE,CAAC,CAAC;YAClC,CAAC;YAED,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC;YAC3B,IAAI,CAAC,WAAW,GAAG,GAAG,CAAC;YAEvB,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW,KAAK,IAAI,CAAC,CAAC,CAAC;gBAC5B,IAAI,CAAC,OAAO,EAAE,CAAC;YACnB,CAAC;YAAC,IAAI,CAAC,CAAC;gBACJ,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,KAAK,OAAA,EAAE,GAAG,KAAA,EAAE,CAAC,CAAC;YACrC,CAAC;QAEL,CAAC;QAAC,IAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,WAAW,KAAK,IAAI,CAAC,CAAC,CAAC;YACnC,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;YACzB,IAAI,CAAC,OAAO,EAAE,CAAC;QACnB,CAAC;IACL,CAAC;IA7KD;QADC,YAAK,EAAE;;yDACU;IAGlB;QADC,YAAK,EAAE;;kEACe;IAGvB;QADC,YAAK,EAAE;;mEACgB;IAGxB;QADC,YAAK,EAAE;;8DACW;IAGnB;QADC,YAAK,EAAE;;+DACY;IAGpB;QADC,aAAM,EAAE;kCACD,mBAAY;0DAAoC;IAGxD;QADC,aAAM,EAAE;kCACD,mBAAY;0DAAgD;IAGpE;QADC,aAAM,EAAE;kCACF,mBAAY;yDAAgD;IAGnE;QADC,aAAM,EAAE;kCACJ,mBAAY;uDAAgD;IAGjE;QADC,gBAAS,CAAC,SAAS,EAAE,EAAE,IAAI,EAAE,iBAAU,EAAE,CAAC;kCACxB,iBAAU;qEAAC;IA9BrB,sBAAsB;QA5BlC,gBAAS,CAAC;YACP,QAAQ,EAAE,gBAAgB;YAC1B,QAAQ,EAAE,iQAKT;YACD,MAAM,EAAE,CAAC,mbAkBR,CAAC;SACL,CAAC;yCAwC+B,iBAAU,EAAoB,eAAQ;OAvC1D,sBAAsB,CAiLlC;IAAD,6BAAC;CAAA,AAjLD,IAiLC;AAjLY,wDAAsB;AAwLnC;IAAA;IAAmC,CAAC;IAAvB,mBAAmB;QAL/B,eAAQ,CAAC;YACN,OAAO,EAAE,CAAC,qBAAY,CAAC;YACvB,OAAO,EAAE,CAAC,sBAAsB,CAAC;YACjC,YAAY,EAAE,CAAC,sBAAsB,CAAC;SACzC,CAAC;OACW,mBAAmB,CAAI;IAAD,0BAAC;CAAA,AAApC,IAAoC;AAAvB,kDAAmB","sourcesContent":["import {\r\n    Component,\r\n    ElementRef,\r\n    EventEmitter,\r\n    Input,\r\n    NgModule,\r\n    OnChanges,\r\n    OnDestroy,\r\n    OnInit,\r\n    Output,\r\n    Renderer,\r\n    SimpleChanges,\r\n    ViewChild,\r\n} from '@angular/core';\r\n\r\nimport { CommonModule } from '@angular/common';\r\n\r\nexport interface ChangeEvent {\r\n    start?: number;\r\n    end?: number;\r\n}\r\n\r\n@Component({\r\n    selector: 'virtual-scroll',\r\n    template: `\r\n        <div class=\"total-padding\" [style.height]=\"scrollHeight + 'px'\"></div>\r\n        <div class=\"scrollable-content\" #content [style.transform]=\"'translateY(' + topPadding + 'px)'\">\r\n            <ng-content></ng-content>\r\n        </div>\r\n    `,\r\n    styles: [`\r\n        :host {\r\n            overflow: auto;\r\n            overflow-y: auto;\r\n            position: relative;\r\n            -webkit-overflow-scrolling: touch;\r\n        }\r\n        .scrollable-content {\r\n            top: 0;\r\n            left: 0;\r\n            width: 100%;\r\n            height: 100%;\r\n            position: absolute;\r\n        }\r\n        .total-padding {\r\n            width: 1px;\r\n            opacity: 0;\r\n        }\r\n    `]\r\n})\r\nexport class VirtualScrollComponent implements OnInit, OnDestroy, OnChanges {\r\n\r\n    @Input()\r\n    items: any[] = [];\r\n\r\n    @Input()\r\n    scrollbarWidth: number;\r\n\r\n    @Input()\r\n    scrollbarHeight: number;\r\n\r\n    @Input()\r\n    childWidth: number;\r\n\r\n    @Input()\r\n    childHeight: number;\r\n\r\n    @Output()\r\n    update: EventEmitter<any[]> = new EventEmitter<any[]>();\r\n\r\n    @Output()\r\n    change: EventEmitter<ChangeEvent> = new EventEmitter<ChangeEvent>();\r\n\r\n    @Output()\r\n    start: EventEmitter<ChangeEvent> = new EventEmitter<ChangeEvent>();\r\n\r\n    @Output()\r\n    end: EventEmitter<ChangeEvent> = new EventEmitter<ChangeEvent>();\r\n\r\n    @ViewChild('content', { read: ElementRef })\r\n    contentElementRef: ElementRef;\r\n\r\n    onScrollListener: Function;\r\n    topPadding: number;\r\n    scrollHeight: number;\r\n    previousStart: number;\r\n    previousEnd: number;\r\n    startupLoop: boolean = true;\r\n\r\n    constructor(private element: ElementRef, private renderer: Renderer) { }\r\n\r\n    ngOnInit() {\r\n        this.onScrollListener = this.renderer.listen(this.element.nativeElement, 'scroll', this.refresh.bind(this));\r\n        this.scrollbarWidth = 0; // this.element.nativeElement.offsetWidth - this.element.nativeElement.clientWidth;\r\n        this.scrollbarHeight = 0; // this.element.nativeElement.offsetHeight - this.element.nativeElement.clientHeight;\r\n    }\r\n\r\n    ngOnChanges(changes: SimpleChanges) {\r\n        this.previousStart = undefined;\r\n        this.previousEnd = undefined;\r\n        this.refresh();\r\n    }\r\n\r\n    ngOnDestroy() {\r\n        // Check that listener has been attached properly:\r\n        // It may be undefined in some cases, e.g. if an exception is thrown, the component is\r\n        // not initialized properly but destroy may be called anyways (e.g. in testing).\r\n        if (this.onScrollListener !== undefined) {\r\n            // this removes the listener\r\n            this.onScrollListener();\r\n        }\r\n    }\r\n\r\n    refresh() {\r\n        requestAnimationFrame(this.calculateItems.bind(this));\r\n    }\r\n\r\n    scrollInto(item: any) {\r\n        let index: number = (this.items || []).indexOf(item);\r\n        if (index < 0 || index >= (this.items || []).length) return;\r\n\r\n        let d = this.calculateDimensions();\r\n        this.element.nativeElement.scrollTop = Math.floor(index / d.itemsPerRow) *\r\n            d.childHeight - Math.max(0, (d.itemsPerCol - 1)) * d.childHeight;\r\n        this.refresh();\r\n    }\r\n\r\n    private countItemsPerRow() {\r\n        let offsetTop;\r\n        let itemsPerRow;\r\n        let children = this.contentElementRef.nativeElement.children;\r\n        for (itemsPerRow = 0; itemsPerRow < children.length; itemsPerRow++) {\r\n            if (offsetTop != undefined && offsetTop !== children[itemsPerRow].offsetTop) break;\r\n            offsetTop = children[itemsPerRow].offsetTop;\r\n        }\r\n        return itemsPerRow;\r\n    }\r\n\r\n    private calculateDimensions() {\r\n        let el = this.element.nativeElement;\r\n        let content = this.contentElementRef.nativeElement;\r\n\r\n        let items = this.items || [];\r\n        let itemCount = items.length;\r\n        let viewWidth = el.clientWidth - this.scrollbarWidth;\r\n        let viewHeight = el.clientHeight - this.scrollbarHeight;\r\n\r\n        let contentDimensions;\r\n        if (this.childWidth == undefined || this.childHeight == undefined) {\r\n            contentDimensions = content.children[0] ? content.children[0].getBoundingClientRect() : {\r\n                width: viewWidth,\r\n                height: viewHeight\r\n            };\r\n        }\r\n        let childWidth = this.childWidth || contentDimensions.width;\r\n        let childHeight = this.childHeight || contentDimensions.height;\r\n\r\n        let itemsPerRow = Math.max(1, this.countItemsPerRow());\r\n        let itemsPerRowByCalc = Math.max(1, Math.floor(viewWidth / childWidth));\r\n        let itemsPerCol = Math.max(1, Math.floor(viewHeight / childHeight));\r\n        if (itemsPerCol === 1 && Math.floor(el.scrollTop / this.scrollHeight * itemCount) + itemsPerRowByCalc >= itemCount) {\r\n            itemsPerRow = itemsPerRowByCalc;\r\n        }\r\n\r\n        return {\r\n            itemCount: itemCount,\r\n            viewWidth: viewWidth,\r\n            viewHeight: viewHeight,\r\n            childWidth: childWidth,\r\n            childHeight: childHeight,\r\n            itemsPerRow: itemsPerRow,\r\n            itemsPerCol: itemsPerCol,\r\n            itemsPerRowByCalc: itemsPerRowByCalc\r\n        };\r\n    }\r\n\r\n    private calculateItems() {\r\n        let el = this.element.nativeElement;\r\n\r\n        let d = this.calculateDimensions();\r\n        let items = this.items || [];\r\n        this.scrollHeight = d.childHeight * d.itemCount / d.itemsPerRow;\r\n        if (this.element.nativeElement.scrollTop > this.scrollHeight) {\r\n            this.element.nativeElement.scrollTop = this.scrollHeight;\r\n        }\r\n\r\n        let indexByScrollTop = el.scrollTop / this.scrollHeight * d.itemCount / d.itemsPerRow;\r\n        let end = Math.min(d.itemCount, Math.ceil(indexByScrollTop) * d.itemsPerRow + d.itemsPerRow * (d.itemsPerCol + 1));\r\n\r\n        let maxStartEnd = end;\r\n        const modEnd = end % d.itemsPerRow;\r\n        if (modEnd) {\r\n            maxStartEnd = end + d.itemsPerRow - modEnd;\r\n        }\r\n        let maxStart = Math.max(0, maxStartEnd - d.itemsPerCol * d.itemsPerRow - d.itemsPerRow);\r\n        let start = Math.min(maxStart, Math.floor(indexByScrollTop) * d.itemsPerRow);\r\n\r\n        this.topPadding = d.childHeight * Math.ceil(start / d.itemsPerRow);\r\n        if (start !== this.previousStart || end !== this.previousEnd) {\r\n\r\n            // update the scroll list\r\n            this.update.emit(items.slice(start, end));\r\n\r\n            // emit 'start' event\r\n            if (start !== this.previousStart && this.startupLoop === false) {\r\n                this.start.emit({ start, end });\r\n            }\r\n\r\n            // emit 'end' event\r\n            if (end !== this.previousEnd && this.startupLoop === false) {\r\n                this.end.emit({ start, end });\r\n            }\r\n\r\n            this.previousStart = start;\r\n            this.previousEnd = end;\r\n\r\n            if (this.startupLoop === true) {\r\n                this.refresh();\r\n            } else {\r\n                this.change.emit({ start, end });\r\n            }\r\n\r\n        } else if (this.startupLoop === true) {\r\n            this.startupLoop = false;\r\n            this.refresh();\r\n        }\r\n    }\r\n}\r\n\r\n@NgModule({\r\n    imports: [CommonModule],\r\n    exports: [VirtualScrollComponent],\r\n    declarations: [VirtualScrollComponent]\r\n})\r\nexport class VirtualScrollModule { }\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}